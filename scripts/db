#!/bin/bash
#
# Local database management script for the web app
# Usage: scripts/db [start|stop|reset|migrate|status]
#
set -euo pipefail

DB_NAME="mcp_stress"
DB_USER="${PGUSER:-$(whoami)}"
DB_HOST="${PGHOST:-localhost}"
DB_PORT="${PGPORT:-5432}"

# Use existing DATABASE_URL if set, otherwise use local defaults
if [[ -z "${DATABASE_URL:-}" ]]; then
  export DATABASE_URL="postgresql://${DB_USER}@${DB_HOST}:${DB_PORT}/${DB_NAME}"
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() { echo -e "${GREEN}[db]${NC} $1"; }
warn() { echo -e "${YELLOW}[db]${NC} $1"; }
error() { echo -e "${RED}[db]${NC} $1" >&2; }

WEB_DIR="$(cd "$(dirname "$0")/../web" && pwd)"

cmd_start() {
  log "Starting PostgreSQL..."

  if [[ "$(uname)" == "Darwin" ]]; then
    brew services start postgresql@17 2>/dev/null || brew services start postgresql 2>/dev/null || {
      error "Could not start PostgreSQL via brew. Start it manually."
      exit 1
    }
  else
    sudo service postgresql start
  fi

  # Wait for postgres to be ready
  for i in {1..10}; do
    if pg_isready -h "$DB_HOST" -p "$DB_PORT" >/dev/null 2>&1; then
      log "PostgreSQL is running"

      # Create database if it doesn't exist
      if ! psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -lqt 2>/dev/null | cut -d \| -f 1 | grep -qw "$DB_NAME"; then
        log "Creating database $DB_NAME..."
        createdb -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" "$DB_NAME" 2>/dev/null || \
          psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -c "CREATE DATABASE $DB_NAME;" postgres >/dev/null
        log "Database created"
      fi

      return 0
    fi
    sleep 1
  done

  error "PostgreSQL failed to start"
  exit 1
}

cmd_stop() {
  log "Stopping PostgreSQL..."
  if [[ "$(uname)" == "Darwin" ]]; then
    brew services stop postgresql@17 2>/dev/null || brew services stop postgresql 2>/dev/null
  else
    sudo service postgresql stop
  fi
  log "PostgreSQL stopped"
}

cmd_status() {
  if pg_isready -h "$DB_HOST" -p "$DB_PORT" >/dev/null 2>&1; then
    log "PostgreSQL is running on $DB_HOST:$DB_PORT"

    if psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -lqt 2>/dev/null | cut -d \| -f 1 | grep -qw "$DB_NAME"; then
      log "Database $DB_NAME exists"
    else
      warn "Database $DB_NAME does not exist"
    fi
  else
    warn "PostgreSQL is not running"
  fi
}

cmd_new() {
  local name="${1:-}"
  if [[ -z "$name" ]]; then
    error "Migration name required"
    echo "Usage: scripts/db new <migration-name>"
    exit 1
  fi

  log "Creating migration: $name"
  cd "$WEB_DIR"
  deno run -A npm:prisma migrate dev --name "$name"
  log "Migration created"
}

cmd_migrate() {
  log "Running migrations..."
  cd "$WEB_DIR"
  deno run -A npm:prisma migrate deploy
  log "Migrations applied"
}

cmd_reset() {
  warn "This will drop and recreate the database. All data will be lost."
  read -p "Are you sure? [y/N] " -n 1 -r
  echo

  if [[ $REPLY =~ ^[Yy]$ ]]; then
    log "Dropping database..."
    dropdb -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" --if-exists "$DB_NAME" 2>/dev/null || \
      psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -c "DROP DATABASE IF EXISTS $DB_NAME;" postgres >/dev/null

    log "Creating database..."
    createdb -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" "$DB_NAME" 2>/dev/null || \
      psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -c "CREATE DATABASE $DB_NAME;" postgres >/dev/null

    log "Running migrations..."
    cd "$WEB_DIR"
    deno run -A npm:prisma migrate deploy

    log "Database reset complete"
  else
    log "Aborted"
  fi
}

cmd_generate() {
  log "Generating Prisma client..."
  cd "$WEB_DIR"
  deno run -A npm:prisma generate
  log "Prisma client generated"
}

cmd_studio() {
  log "Opening Prisma Studio..."
  cd "$WEB_DIR"
  deno run -A npm:prisma studio
}

cmd_help() {
  echo "Usage: scripts/db <command>"
  echo ""
  echo "Commands:"
  echo "  start         Start PostgreSQL and create database if needed"
  echo "  stop          Stop PostgreSQL"
  echo "  status        Check PostgreSQL and database status"
  echo "  new <name>    Create a new migration with the given name"
  echo "  migrate       Run pending migrations (deploy)"
  echo "  reset         Drop and recreate database (WARNING: destroys data)"
  echo "  generate      Generate Prisma client"
  echo "  studio        Open Prisma Studio"
  echo ""
  echo "Environment:"
  echo "  DATABASE_URL=$DATABASE_URL"
}

case "${1:-help}" in
  start)    cmd_start ;;
  stop)     cmd_stop ;;
  status)   cmd_status ;;
  new)      cmd_new "${2:-}" ;;
  migrate)  cmd_migrate ;;
  reset)    cmd_reset ;;
  generate) cmd_generate ;;
  studio)   cmd_studio ;;
  help|--help|-h) cmd_help ;;
  *)
    error "Unknown command: $1"
    cmd_help
    exit 1
    ;;
esac
